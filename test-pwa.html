<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <title>Teste PWA - Ghostbusters AR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #000;
            color: #92F428;
            padding: 20px;
            margin: 0;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-section {
            background: rgba(146, 244, 40, 0.1);
            border: 1px solid #92F428;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-button {
            background: #92F428;
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        
        .test-button:hover {
            background: #7BC91F;
        }
        
        .test-result {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }
        
        .status-good { color: #4CAF50; }
        .status-warning { color: #FF9800; }
        .status-error { color: #F44336; }
        
        h1, h2 {
            color: #92F428;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .metric-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(146, 244, 40, 0.3);
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #92F428;
        }
        
        .metric-label {
            color: #cccccc;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üéÆ Teste PWA - Ghostbusters AR</h1>
        
        <!-- Status Geral -->
        <div class="test-section">
            <h2>üìä Status Geral</h2>
            <div class="metric-grid" id="general-status">
                <div class="metric-card">
                    <div class="metric-label">Service Worker</div>
                    <div class="metric-value" id="sw-status">Verificando...</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Cache API</div>
                    <div class="metric-value" id="cache-status">Verificando...</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">PWA Instal√°vel</div>
                    <div class="metric-value" id="installable-status">Verificando...</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Modo Offline</div>
                    <div class="metric-value" id="offline-status">Online</div>
                </div>
            </div>
        </div>
        
        <!-- Testes de Loading -->
        <div class="test-section">
            <h2>‚è≥ Sistema de Loading</h2>
            <button class="test-button" onclick="testLoadingScreen()">Testar Tela de Loading</button>
            <button class="test-button" onclick="testProgressIndicators()">Testar Indicadores</button>
            <button class="test-button" onclick="testQuickLoader()">Testar Quick Loader</button>
            <div class="test-result" id="loading-result"></div>
        </div>
        
        <!-- Testes de Cache -->
        <div class="test-section">
            <h2>üíæ Sistema de Cache</h2>
            <button class="test-button" onclick="testCacheOperations()">Testar Opera√ß√µes</button>
            <button class="test-button" onclick="testPreloadAssets()">Testar Pr√©-carregamento</button>
            <button class="test-button" onclick="showCacheStats()">Estat√≠sticas</button>
            <button class="test-button" onclick="clearAllCache()">Limpar Cache</button>
            <div class="test-result" id="cache-result"></div>
        </div>
        
        <!-- Testes de Performance -->
        <div class="test-section">
            <h2>‚ö° Monitor de Performance</h2>
            <button class="test-button" onclick="showPerformanceMetrics()">M√©tricas Atuais</button>
            <button class="test-button" onclick="testPerformanceOperation()">Testar Opera√ß√£o</button>
            <button class="test-button" onclick="togglePerformanceWidget()">Toggle Widget</button>
            <button class="test-button" onclick="simulateHighLoad()">Simular Carga Alta</button>
            <div class="test-result" id="performance-result"></div>
        </div>
        
        <!-- Testes de PWA -->
        <div class="test-section">
            <h2>üì± Recursos PWA</h2>
            <button class="test-button" onclick="testInstallPrompt()">Testar Instala√ß√£o</button>
            <button class="test-button" onclick="testNotifications()">Testar Notifica√ß√µes</button>
            <button class="test-button" onclick="testOfflineMode()">Simular Offline</button>
            <button class="test-button" onclick="checkPWAFeatures()">Verificar Recursos</button>
            <div class="test-result" id="pwa-result"></div>
        </div>
        
        <!-- Logs em Tempo Real -->
        <div class="test-section">
            <h2>üìù Logs em Tempo Real</h2>
            <button class="test-button" onclick="clearLogs()">Limpar Logs</button>
            <button class="test-button" onclick="toggleAutoScroll()">Auto Scroll</button>
            <div class="test-result" id="live-logs" style="height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Scripts PWA -->
    <script src="performance-monitor.js"></script>
    <script src="progress-indicators.js"></script>
    <script src="cache-manager.js"></script>
    <script src="pwa-manager.js"></script>
    <script src="loading-manager.js"></script>

    <script>
        // Vari√°veis globais para teste
        let autoScroll = true;
        let logCount = 0;
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeTests();
            setupLogCapture();
            updateStatus();
            
            // Atualiza status a cada 5 segundos
            setInterval(updateStatus, 5000);
        });
        
        async function initializeTests() {
            log('üöÄ Iniciando testes PWA...');
            
            // Aguarda inicializa√ß√£o dos sistemas
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            log('‚úÖ Sistemas PWA carregados');
        }
        
        function updateStatus() {
            // Service Worker
            const swStatus = document.getElementById('sw-status');
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(reg => {
                    swStatus.textContent = reg ? '‚úÖ Ativo' : '‚ùå Inativo';
                    swStatus.className = reg ? 'status-good' : 'status-error';
                });
            } else {
                swStatus.textContent = '‚ùå N√£o Suportado';
                swStatus.className = 'status-error';
            }
            
            // Cache API
            const cacheStatus = document.getElementById('cache-status');
            if ('caches' in window) {
                cacheStatus.textContent = '‚úÖ Suportado';
                cacheStatus.className = 'status-good';
            } else {
                cacheStatus.textContent = '‚ùå N√£o Suportado';
                cacheStatus.className = 'status-error';
            }
            
            // PWA Instal√°vel
            const installableStatus = document.getElementById('installable-status');
            if (window.pwaManager && window.pwaManager.deferredPrompt) {
                installableStatus.textContent = '‚úÖ Sim';
                installableStatus.className = 'status-good';
            } else {
                installableStatus.textContent = '‚ùì N√£o Detectado';
                installableStatus.className = 'status-warning';
            }
            
            // Status Offline
            const offlineStatus = document.getElementById('offline-status');
            if (navigator.onLine) {
                offlineStatus.textContent = 'üåê Online';
                offlineStatus.className = 'status-good';
            } else {
                offlineStatus.textContent = 'üì¥ Offline';
                offlineStatus.className = 'status-warning';
            }
        }
        
        // Testes de Loading
        async function testLoadingScreen() {
            log('üîÑ Testando tela de loading...');
            
            if (window.loadingManager) {
                loadingManager.show('Teste de Loading');
                
                for (let i = 0; i <= 100; i += 10) {
                    loadingManager.updateProgress(i, `Progresso: ${i}%`, i, 100);
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                loadingManager.hide();
                log('‚úÖ Teste de loading conclu√≠do');
            } else {
                log('‚ùå Loading Manager n√£o encontrado');
            }
        }
        
        async function testProgressIndicators() {
            log('üìä Testando indicadores de progresso...');
            
            if (window.progressIndicators) {
                // Indicador circular
                const circularId = 'test-circular';
                progressIndicators.createIndicator(circularId, {
                    type: 'circular',
                    position: 'center'
                });
                progressIndicators.showIndicator(circularId);
                
                for (let i = 0; i <= 100; i += 5) {
                    progressIndicators.updateIndicator(circularId, i, `${i}%`);
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                progressIndicators.removeIndicator(circularId);
                log('‚úÖ Teste de indicadores conclu√≠do');
            } else {
                log('‚ùå Progress Indicators n√£o encontrado');
            }
        }
        
        function testQuickLoader() {
            log('‚ö° Testando quick loader...');
            
            if (window.loadingManager) {
                loadingManager.showQuickLoading('Opera√ß√£o r√°pida...', 2000);
                log('‚úÖ Quick loader ativado');
            } else {
                log('‚ùå Loading Manager n√£o encontrado');
            }
        }
        
        // Testes de Cache
        async function testCacheOperations() {
            log('üíæ Testando opera√ß√µes de cache...');
            
            if (window.cacheManager) {
                try {
                    // Testa cache de um recurso
                    const testUrl = window.location.href;
                    await cacheManager.cacheResource(testUrl, 'cache-first');
                    
                    const isCached = await cacheManager.isResourceCached(testUrl);
                    log(`‚úÖ Recurso cacheado: ${isCached}`);
                    
                    const stats = cacheManager.getStats();
                    log(`üìà Stats: ${stats.hits} hits, ${stats.misses} misses`);
                } catch (error) {
                    log(`‚ùå Erro no teste de cache: ${error.message}`);
                }
            } else {
                log('‚ùå Cache Manager n√£o encontrado');
            }
        }
        
        async function testPreloadAssets() {
            log('üì¶ Testando pr√©-carregamento...');
            
            if (window.cacheManager) {
                const testAssets = [
                    window.location.href,
                    'favicon.ico',
                    'site.webmanifest'
                ];
                
                try {
                    const result = await cacheManager.preloadResources(testAssets, (loaded, total, url) => {
                        log(`üì• ${loaded}/${total}: ${url.split('/').pop()}`);
                    });
                    
                    log(`‚úÖ Pr√©-carregamento: ${result.successful}/${result.total} sucessos`);
                } catch (error) {
                    log(`‚ùå Erro no pr√©-carregamento: ${error.message}`);
                }
            } else {
                log('‚ùå Cache Manager n√£o encontrado');
            }
        }
        
        async function showCacheStats() {
            log('üìä Estat√≠sticas do cache...');
            
            if (window.cacheManager) {
                const stats = cacheManager.getStats();
                const cachedResources = await cacheManager.listCachedResources();
                
                log(`üìà Estat√≠sticas:`);
                log(`  - Hits: ${stats.hits}`);
                log(`  - Misses: ${stats.misses}`);
                log(`  - Hit Rate: ${Math.round(stats.hitRate)}%`);
                log(`  - Recursos em cache: ${cachedResources.length}`);
                log(`  - Suportado: ${stats.supported ? 'Sim' : 'N√£o'}`);
            } else {
                log('‚ùå Cache Manager n√£o encontrado');
            }
        }
        
        async function clearAllCache() {
            log('üóëÔ∏è Limpando cache...');
            
            if (window.cacheManager) {
                const success = await cacheManager.clearCache();
                log(success ? '‚úÖ Cache limpo' : '‚ùå Erro ao limpar cache');
            } else {
                log('‚ùå Cache Manager n√£o encontrado');
            }
        }
        
        // Testes de Performance
        function showPerformanceMetrics() {
            log('‚ö° M√©tricas de performance...');
            
            if (window.performanceMonitor) {
                const metrics = performanceMonitor.getAllMetrics();
                
                log(`üìä M√©tricas atuais:`);
                log(`  - FPS: ${metrics.fps || 'N/A'}`);
                log(`  - Mem√≥ria: ${metrics.memoryUsage ? `${metrics.memoryUsage.used}MB` : 'N/A'}`);
                log(`  - Cache Hit Rate: ${Math.round(metrics.cacheHitRate || 0)}%`);
                log(`  - Conex√£o: ${metrics.connectionType}`);
                log(`  - Bateria: ${metrics.batteryLevel !== null ? `${metrics.batteryLevel}%` : 'N/A'}`);
                log(`  - Requisi√ß√µes: ${metrics.networkRequests}`);
            } else {
                log('‚ùå Performance Monitor n√£o encontrado');
            }
        }
        
        async function testPerformanceOperation() {
            log('üî¨ Testando opera√ß√£o de performance...');
            
            if (window.performanceMonitor) {
                const operation = performanceMonitor.startOperation('test-operation');
                
                // Simula opera√ß√£o pesada
                await new Promise(resolve => {
                    let sum = 0;
                    for (let i = 0; i < 1000000; i++) {
                        sum += Math.random();
                    }
                    setTimeout(resolve, 100);
                });
                
                const duration = operation.end();
                log(`‚úÖ Opera√ß√£o conclu√≠da em ${Math.round(duration)}ms`);
            } else {
                log('‚ùå Performance Monitor n√£o encontrado');
            }
        }
        
        function togglePerformanceWidget() {
            const widget = document.getElementById('performance-monitor-widget');
            if (widget) {
                widget.classList.toggle('hidden');
                log('üîß Widget de performance alternado');
            } else {
                log('‚ùå Widget de performance n√£o encontrado');
            }
        }
        
        function simulateHighLoad() {
            log('üî• Simulando carga alta...');
            
            // Simula uso intenso de CPU
            const startTime = Date.now();
            const duration = 3000; // 3 segundos
            
            const heavyLoop = () => {
                const now = Date.now();
                if (now - startTime < duration) {
                    // Opera√ß√£o pesada
                    for (let i = 0; i < 100000; i++) {
                        Math.random() * Math.random();
                    }
                    requestAnimationFrame(heavyLoop);
                } else {
                    log('‚úÖ Simula√ß√£o de carga alta conclu√≠da');
                }
            };
            
            heavyLoop();
        }
        
        // Testes PWA
        function testInstallPrompt() {
            log('üì± Testando prompt de instala√ß√£o...');
            
            if (window.pwaManager) {
                if (pwaManager.deferredPrompt) {
                    pwaManager.installApp();
                    log('‚úÖ Prompt de instala√ß√£o ativado');
                } else {
                    log('‚ö†Ô∏è Prompt de instala√ß√£o n√£o dispon√≠vel');
                }
            } else {
                log('‚ùå PWA Manager n√£o encontrado');
            }
        }
        
        function testNotifications() {
            log('üîî Testando notifica√ß√µes...');
            
            if (window.pwaManager) {
                pwaManager.showNotification('Teste de notifica√ß√£o PWA!', 'info');
                log('‚úÖ Notifica√ß√£o enviada');
            } else {
                log('‚ùå PWA Manager n√£o encontrado');
            }
        }
        
        function testOfflineMode() {
            log('üì¥ Simulando modo offline...');
            
            // Simula mudan√ßa de status offline
            window.dispatchEvent(new Event('offline'));
            
            setTimeout(() => {
                window.dispatchEvent(new Event('online'));
                log('üåê Voltando ao modo online');
            }, 3000);
            
            log('‚ö†Ô∏è Modo offline simulado por 3 segundos');
        }
        
        async function checkPWAFeatures() {
            log('üîç Verificando recursos PWA...');
            
            const features = {
                'Service Worker': 'serviceWorker' in navigator,
                'Cache API': 'caches' in window,
                'Push API': 'PushManager' in window,
                'Notifications': 'Notification' in window,
                'Background Sync': 'serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype,
                'Web Share': 'share' in navigator,
                'Install Prompt': 'BeforeInstallPromptEvent' in window,
                'Fullscreen': 'requestFullscreen' in document.documentElement,
                'Geolocation': 'geolocation' in navigator,
                'Device Motion': 'DeviceMotionEvent' in window,
                'Battery API': 'getBattery' in navigator,
                'Network Info': 'connection' in navigator
            };
            
            log('üìã Recursos PWA dispon√≠veis:');
            Object.entries(features).forEach(([feature, supported]) => {
                const status = supported ? '‚úÖ' : '‚ùå';
                log(`  ${status} ${feature}`);
            });
        }
        
        // Sistema de Logs
        function setupLogCapture() {
            // Captura logs do console
            const originalLog = console.log;
            const originalWarn = console.warn;
            const originalError = console.error;
            
            console.log = function(...args) {
                originalLog.apply(console, args);
                if (args[0] && typeof args[0] === 'string' && 
                    (args[0].includes('[PWA]') || args[0].includes('[Cache]') || 
                     args[0].includes('[Performance]') || args[0].includes('[App]'))) {
                    log(args.join(' '));
                }
            };
            
            console.warn = function(...args) {
                originalWarn.apply(console, args);
                if (args[0] && typeof args[0] === 'string' && 
                    (args[0].includes('[PWA]') || args[0].includes('[Cache]') || 
                     args[0].includes('[Performance]') || args[0].includes('[App]'))) {
                    log(`‚ö†Ô∏è ${args.join(' ')}`);
                }
            };
            
            console.error = function(...args) {
                originalError.apply(console, args);
                if (args[0] && typeof args[0] === 'string' && 
                    (args[0].includes('[PWA]') || args[0].includes('[Cache]') || 
                     args[0].includes('[Performance]') || args[0].includes('[App]'))) {
                    log(`‚ùå ${args.join(' ')}`);
                }
            };
        }
        
        function log(message) {
            const logsContainer = document.getElementById('live-logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            
            logsContainer.textContent += logEntry;
            logCount++;
            
            // Limita n√∫mero de logs
            if (logCount > 100) {
                const lines = logsContainer.textContent.split('\n');
                logsContainer.textContent = lines.slice(-50).join('\n');
                logCount = 50;
            }
            
            // Auto scroll
            if (autoScroll) {
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }
        
        function clearLogs() {
            document.getElementById('live-logs').textContent = '';
            logCount = 0;
            log('üìù Logs limpos');
        }
        
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            log(`üìú Auto scroll: ${autoScroll ? 'Ativado' : 'Desativado'}`);
        }
        
        // Event listeners para eventos PWA
        window.addEventListener('app-ready', (event) => {
            log('üöÄ App pronto: ' + JSON.stringify(event.detail.status));
        });
        
        window.addEventListener('power-mode-change', (event) => {
            log(`üîã Modo de energia: ${event.detail.mode}`);
        });
        
        window.addEventListener('bandwidth-mode-change', (event) => {
            log(`üì∂ Modo de largura de banda: ${event.detail.mode}`);
        });
        
        window.addEventListener('low-fps-detected', (event) => {
            log(`‚ö° FPS baixo detectado: ${event.detail.fps}`);
        });
        
        window.addEventListener('online', () => {
            log('üåê Conex√£o restaurada');
            updateStatus();
        });
        
        window.addEventListener('offline', () => {
            log('üì¥ Conex√£o perdida');
            updateStatus();
        });
    </script>
</body>
</html>